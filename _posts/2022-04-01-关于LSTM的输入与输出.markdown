---
layout: post
title: å…³äºŽLSTMçš„è¾“å…¥ä¸Žè¾“å‡º
categories: [æ·±åº¦å­¦ä¹ ]
comments: true
description: LSTMç¥žç»ç½‘ç»œè¾“å…¥è¾“å‡ºç©¶ç«Ÿæ˜¯æ€Žæ ·çš„å‘¢ï¼Ÿ
---

# LSTMçš„è¾“å…¥ä¸Žè¾“å‡º
## 1. å‰ç½®
ðŸ’¡ LSTMç®—æ³•åœ¨æ—¶åºé¢„æµ‹é¢†åŸŸåº”ç”¨æ¯”è¾ƒå¹¿æ³›ï¼ŒLSTMæœ¬è´¨ä¸Šæ˜¯åœ¨åŽŸæœ‰å…¨è¿žæŽ¥ç¥žç»ç½‘ç»œçš„åŸºç¡€ä¸Šï¼Œå¢žåŠ äº†ä¸€ä¸ªæ—¶é—´è½´çš„æ¦‚å¿µï¼ŒåŒæ ·çš„æ•°æ®ï¼Œä¸åŒçš„è¾“å…¥é¡ºåºï¼Œä¼šå¾—åˆ°ä¸åŒçš„ç»“æžœã€‚è¿™æ ·çš„æ•ˆæžœå¤©ç”Ÿé€‚åˆå¤„ç†è·Ÿæ—¶åºæœ‰å…³çš„æ•°æ®ã€‚åœ¨å®žé™…ä½¿ç”¨è¿‡ç¨‹å½“ä¸­ï¼ŒLSTMç¥žç»ç½‘ç»œè¾“å…¥è¾“å‡ºç©¶ç«Ÿæ˜¯æ€Žæ ·çš„å‘¢ï¼Ÿ


## 2. LSTMç†è§£
### 2.1 LSTMæ¨¡åž‹å‚æ•°å«ä¹‰
LSTMï¼ˆé•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼‰æ˜¯ä¸€ç§å¾ªçŽ¯ç¥žç»ç½‘ç»œï¼ˆRNNï¼‰çš„å˜ä½“ï¼Œä¸“é—¨è®¾è®¡ç”¨äºŽå¤„ç†åºåˆ—æ•°æ®ã€‚ç›¸æ¯”äºŽä¼ ç»Ÿçš„RNNï¼ŒLSTMèƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†é•¿æœŸä¾èµ–å…³ç³»ï¼Œé¿å…æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸ç­‰é—®é¢˜ã€‚LSTMçš„æ ¸å¿ƒæ€æƒ³æ˜¯å¼•å…¥äº†ç§°ä¸º"é—¨"çš„æœºåˆ¶ï¼ŒåŒ…æ‹¬è¾“å…¥é—¨ã€é—å¿˜é—¨å’Œè¾“å‡ºé—¨ï¼Œä»¥æŽ§åˆ¶ä¿¡æ¯çš„æµåŠ¨å’Œè®°å¿†çš„æ›´æ–°ã€‚
```
LSTMå•å…ƒç»“æž„ï¼š LSTMå•å…ƒç”±ä»¥ä¸‹å‡ ä¸ªé‡è¦çš„ç»„ä»¶ç»„æˆï¼š
1. è¾“å…¥é—¨ï¼ˆInput Gateï¼‰ï¼šæŽ§åˆ¶æ˜¯å¦å°†æ–°çš„è¾“å…¥ä¿¡æ¯çº³å…¥åˆ°ç»†èƒžçŠ¶æ€ä¸­ã€‚

2. é—å¿˜é—¨ï¼ˆForget Gateï¼‰ï¼šæŽ§åˆ¶æ˜¯å¦å°†æ—§çš„ç»†èƒžçŠ¶æ€ä¿ç•™ä¸‹æ¥ã€‚

3. ç»†èƒžçŠ¶æ€ï¼ˆCell Stateï¼‰ï¼šè´Ÿè´£å­˜å‚¨å’Œä¼ é€’ä¿¡æ¯ã€‚

4. è¾“å‡ºé—¨ï¼ˆOutput Gateï¼‰ï¼šæŽ§åˆ¶æœ€ç»ˆè¾“å‡ºçš„ä¿¡æ¯ã€‚
```

![avatar](../images/2022/lstm-alg.png)

#### LSTMå•å…ƒå·¥ä½œæµç¨‹ï¼š ä¸‹é¢æ˜¯ä¸€ä¸ªLSTMå•å…ƒçš„å·¥ä½œæµç¨‹ï¼š
```
æ­¥éª¤1ï¼šè¾“å…¥é—¨å†³å®šäº†å“ªäº›ä¿¡æ¯éœ€è¦æ›´æ–°åˆ°ç»†èƒžçŠ¶æ€ä¸­ã€‚å®ƒé€šè¿‡ä½¿ç”¨Sigmoidæ¿€æ´»å‡½æ•°æ¥ç”Ÿæˆä¸€ä¸ª0åˆ°1ä¹‹é—´çš„å€¼ã€‚æŽ¥ä¸‹æ¥ï¼Œå°†å½“å‰çš„è¾“å…¥å’Œå…ˆå‰çš„éšè—çŠ¶æ€ä½œä¸ºè¾“å…¥ï¼Œé€šè¿‡ä¸€ä¸ªå…¨è¿žæŽ¥å±‚æ¥è®¡ç®—è¾“å…¥é—¨çš„è¾“å‡ºã€‚

æ­¥éª¤2ï¼šé—å¿˜é—¨å†³å®šå“ªäº›æ—§çš„ç»†èƒžçŠ¶æ€éœ€è¦è¢«ä¿ç•™ä¸‹æ¥ã€‚å®ƒä¹Ÿä½¿ç”¨Sigmoidæ¿€æ´»å‡½æ•°ç”Ÿæˆä¸€ä¸ª0åˆ°1ä¹‹é—´çš„å€¼ï¼ŒæŽ§åˆ¶æ—§ç»†èƒžçŠ¶æ€çš„ä¿ç•™ç¨‹åº¦ã€‚åŒæ ·ï¼Œé€šè¿‡ä¸€ä¸ªå…¨è¿žæŽ¥å±‚è®¡ç®—é—å¿˜é—¨çš„è¾“å‡ºã€‚

æ­¥éª¤3ï¼šç»†èƒžçŠ¶æ€æ›´æ–°æ ¹æ®è¾“å…¥é—¨å’Œé—å¿˜é—¨çš„è¾“å‡ºæ¥æ›´æ–°å½“å‰çš„ç»†èƒžçŠ¶æ€ã€‚é¦–å…ˆï¼Œå°†è¾“å…¥é—¨çš„è¾“å‡ºä¹˜ä»¥å½“å‰çš„è¾“å…¥ï¼Œå¾—åˆ°ä¸€ä¸ªå€™é€‰ç»†èƒžçŠ¶æ€ã€‚ç„¶åŽï¼Œå°†é—å¿˜é—¨çš„è¾“å‡ºä¸Žå…ˆå‰çš„ç»†èƒžçŠ¶æ€ç›¸ä¹˜ï¼Œå¾—åˆ°éœ€è¦è¢«é—å¿˜çš„éƒ¨åˆ†ã€‚æœ€åŽï¼Œå°†ä¸¤è€…ç›¸åŠ å¾—åˆ°æ–°çš„ç»†èƒžçŠ¶æ€ã€‚

æ­¥éª¤4ï¼šè¾“å‡ºé—¨å†³å®šLSTMå•å…ƒçš„æœ€ç»ˆè¾“å‡ºã€‚å®ƒé€šè¿‡ä½¿ç”¨Sigmoidæ¿€æ´»å‡½æ•°å’ŒTanhæ¿€æ´»å‡½æ•°æ¥ç”Ÿæˆä¸€ä¸ª0åˆ°1ä¹‹é—´çš„å€¼å’Œä¸€ä¸ª-1åˆ°1ä¹‹é—´çš„å€¼ã€‚å°†å½“å‰çš„è¾“å…¥å’Œå…ˆå‰çš„éšè—çŠ¶æ€ä½œä¸ºè¾“å…¥ï¼Œé€šè¿‡ä¸¤ä¸ªå…¨è¿žæŽ¥å±‚åˆ†åˆ«è®¡ç®—è¾“å‡ºé—¨çš„ä¸¤ä¸ªéƒ¨åˆ†çš„è¾“å‡ºã€‚æœ€åŽï¼Œå°†è¿™ä¸¤ä¸ªéƒ¨åˆ†ç›¸ä¹˜å¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºã€‚
```

LSTMé€šè¿‡ä»¥ä¸Šçš„è¿‡ç¨‹æ¥å®žçŽ°å¯¹åºåˆ—æ•°æ®çš„å»ºæ¨¡å’Œè®°å¿†ï¼Œä»Žè€Œèƒ½å¤Ÿå¤„ç†é•¿æœŸä¾èµ–å…³ç³»ã€‚

##### æ¼”ç¤ºï¼š ä»¥ä¸‹æ˜¯ä½¿ç”¨Pythonå’ŒPyTorchåº“æ¥æ¼”ç¤ºLSTMçš„ç®€å•å®žçŽ°ï¼š
```
import torch
import torch.nn as nn

# å®šä¹‰ä¸€ä¸ªç®€å•çš„LSTMæ¨¡åž‹
class LSTMModel(nn.Module):
    def __init__(self, input_size, hidden_size):
        super(LSTMModel, self).__init__()
        self.hidden_size = hidden_size
        self.lstm = nn.LSTM(input_size, hidden_size)
        
    def forward(self, input):
        output, (hidden, cell) = self.lstm(input)
        return output, hidden, cell

# åˆ›å»ºä¸€ä¸ªè¾“å…¥åºåˆ—
input_seq = torch.randn(5, 3, 10)  # è¾“å…¥åºåˆ—é•¿åº¦ä¸º5ï¼Œbatchå¤§å°ä¸º3ï¼Œç‰¹å¾ç»´åº¦ä¸º10

# åˆ›å»ºLSTMæ¨¡åž‹
input_size = 10
hidden_size = 20
model = LSTMModel(input_size, hidden_size)

# è¾“å…¥åºåˆ—åˆ°LSTMæ¨¡åž‹ä¸­
output_seq, hidden, cell = model(input_seq)

# æ‰“å°è¾“å‡ºç»“æžœ
print("Output Sequence:")
print(output_seq)
print("\nHidden State:")
print(hidden)
print("\nCell State:")
print(cell)
```

## 3. Pytorchæºä»£ç å‚æ•°ç†è§£
### 3.1 LSTMæ¨¡åž‹å‚æ•°å«ä¹‰
é€šè¿‡æºä»£ç ä¸­å¯ä»¥çœ‹åˆ°nn.LSTMç»§æ‰¿è‡ªnn.RNNBase,å…¶åˆå§‹åŒ–å‡½æ•°å®šä¹‰å¦‚ä¸‹
```
class RNNBase(Module):
	...
    def __init__(self, mode, input_size, hidden_size,
                 num_layers=1, bias=True, batch_first=False,
                 dropout=0., bidirectional=False):
```
##### éœ€è¦å…³æ³¨çš„ä¸»è¦å‚æ•°ä»¥åŠå…¶å«ä¹‰è§£é‡Šå¦‚ä¸‹ï¼š
```
input_size â€“ è¾“å…¥æ•°æ®çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯å‰é¢ä¾‹å­ä¸­æ¯ä¸ªå•è¯å‘é‡çš„é•¿åº¦
hidden_size â€“ éšè—å±‚çš„å¤§å°ï¼ˆå³éšè—å±‚èŠ‚ç‚¹æ•°é‡ï¼‰ï¼Œè¾“å‡ºå‘é‡çš„ç»´åº¦ç­‰äºŽéšè—èŠ‚ç‚¹æ•°
num_layers â€“ recurrent layerçš„æ•°é‡ï¼Œé»˜è®¤ç­‰äºŽ1ã€‚
bias â€“ åç½® Default: True
batch_first â€“ é»˜è®¤ä¸ºFalseï¼Œä¹Ÿå°±æ˜¯è¯´å®˜æ–¹ä¸æŽ¨èæˆ‘ä»¬æŠŠbatchæ”¾åœ¨ç¬¬ä¸€ç»´ï¼Œè¿™ä¸ªCNNæœ‰ç‚¹ä¸åŒï¼Œæ­¤æ—¶è¾“å…¥è¾“å‡ºçš„å„ä¸ªç»´åº¦å«ä¹‰ä¸º (seq_length,batch,feature)ã€‚å½“ç„¶å¦‚æžœä½ æƒ³å’ŒCNNä¸€æ ·æŠŠbatchæ”¾åœ¨ç¬¬ä¸€ç»´ï¼Œå¯å°†è¯¥å‚æ•°è®¾ç½®ä¸ºTrueã€‚
dropout â€“ å¦‚æžœéž0ï¼Œå°±åœ¨é™¤äº†æœ€åŽä¸€å±‚çš„å…¶å®ƒå±‚éƒ½æ’å…¥Dropoutå±‚ï¼Œé»˜è®¤ä¸º0ã€‚
bidirectional â€“ å¦‚æžœä¸ºTrue, åŒå‘LSTM. Default: False

```


##### è¾“å…¥æ•°æ®
```
è¾“å…¥æ•°æ®éœ€è¦æŒ‰å¦‚ä¸‹å½¢å¼ä¼ å…¥ input, (h_0,c_0)

input: è¾“å…¥æ•°æ®ï¼Œå³ä¸Šé¢ä¾‹å­ä¸­çš„ä¸€ä¸ªå¥å­ï¼ˆæˆ–è€…ä¸€ä¸ªbatchçš„å¥å­ï¼‰ï¼Œå…¶ç»´åº¦å½¢çŠ¶ä¸º (seq_len, batch, input_size)
seq_len: å¥å­é•¿åº¦ï¼Œå³å•è¯æ•°é‡ï¼Œè¿™ä¸ªæ˜¯éœ€è¦å›ºå®šçš„ã€‚å½“ç„¶å‡å¦‚ä½ çš„ä¸€ä¸ªå¥å­ä¸­åªæœ‰2ä¸ªå•è¯ï¼Œä½†æ˜¯è¦æ±‚è¾“å…¥10ä¸ªå•è¯ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ç”¨torch.nn.utils.rnn.pack_padded_sequence()æˆ–è€…torch.nn.utils.rnn.pack_sequence()æ¥å¯¹å¥å­è¿›è¡Œå¡«å……æˆ–è€…æˆªæ–­ã€‚
batchï¼šå°±æ˜¯ä½ ä¸€æ¬¡ä¼ å…¥çš„å¥å­çš„æ•°é‡
input_size: æ¯ä¸ªå•è¯å‘é‡çš„é•¿åº¦ï¼Œè¿™ä¸ªå¿…é¡»å’Œä½ å‰é¢å®šä¹‰çš„ç½‘ç»œç»“æž„ä¿æŒä¸€è‡´

h_0ï¼šç»´åº¦å½¢çŠ¶ä¸º (num_layers * num_directions, batch, hidden_size):
ç»“åˆä¸‹å›¾åº”è¯¥æ¯”è¾ƒå¥½ç†è§£ç¬¬ä¸€ä¸ªå‚æ•°çš„å«ä¹‰num_layers * num_directionsï¼Œ å³LSTMçš„å±‚æ•°ä¹˜ä»¥æ–¹å‘æ•°é‡ã€‚è¿™ä¸ªæ–¹å‘æ•°é‡æ˜¯ç”±å‰é¢ä»‹ç»çš„bidirectionalå†³å®šï¼Œå¦‚æžœä¸ºFalse,åˆ™ç­‰äºŽ1ï¼›åä¹‹ç­‰äºŽ2ã€‚
batchï¼šåŒä¸Š
hidden_size: éšè—å±‚èŠ‚ç‚¹æ•°
c_0ï¼š ç»´åº¦å½¢çŠ¶ä¸º (num_layers * num_directions, batch, hidden_size),å„å‚æ•°å«ä¹‰å’Œh_0ç±»ä¼¼ã€‚
å½“ç„¶ï¼Œå¦‚æžœä½ æ²¡æœ‰ä¼ å…¥(h_0, c_0)ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå‚æ•°ä¼šé»˜è®¤è®¾ç½®ä¸º0ã€‚

```


##### è¾“å‡ºæ•°æ®
```
outputï¼š ç»´åº¦å’Œè¾“å…¥æ•°æ®ç±»ä¼¼ï¼Œåªä¸è¿‡æœ€åŽçš„featureéƒ¨åˆ†ä¼šæœ‰ç‚¹ä¸åŒï¼Œå³ (seq_len, batch, num_directions * hidden_size)
è¿™ä¸ªè¾“å‡ºtensoråŒ…å«äº†LSTMæ¨¡åž‹æœ€åŽä¸€å±‚æ¯ä¸ªtime stepçš„è¾“å‡ºç‰¹å¾ï¼Œæ¯”å¦‚è¯´LSTMæœ‰ä¸¤å±‚ï¼Œé‚£ä¹ˆæœ€åŽè¾“å‡ºçš„æ˜¯
,è¡¨ç¤ºç¬¬äºŒå±‚LSTMæ¯ä¸ªtime stepå¯¹åº”çš„è¾“å‡ºã€‚
å¦å¤–å¦‚æžœå‰é¢ä½ å¯¹è¾“å…¥æ•°æ®ä½¿ç”¨äº†torch.nn.utils.rnn.PackedSequence,é‚£ä¹ˆè¾“å‡ºä¹Ÿä¼šåšåŒæ ·çš„æ“ä½œç¼–ç¨‹packed sequenceã€‚
å¯¹äºŽunpackedæƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¾“å‡ºåšå¦‚ä¸‹å¤„ç†æ¥å¯¹æ–¹å‘ä½œåˆ†ç¦»output.view(seq_len, batch, num_directions, hidden_size), å…¶ä¸­å‰å‘å’ŒåŽå‘åˆ†åˆ«ç”¨0å’Œ1è¡¨ç¤ºSimilarly, the directions can be separated in the packed case.


h_nï¼š(num_layers * num_directions, batch, hidden_size)ï¼Œ
åªä¼šè¾“å‡ºæœ€åŽä¸ªtime stepçš„éšçŠ¶æ€ç»“æžœï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚
Like output, the layers can be separated using h_n.view(num_layers, num_directions, batch, hidden_size) and similarly for c_n.
c_n ï¼š(num_layers * num_directions, batch, hidden_size)ï¼Œåªä¼šè¾“å‡ºæœ€åŽä¸ªtime stepçš„cellçŠ¶æ€ç»“æžœï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚
```

### 5. å‚è€ƒæ–‡æ¡£
> 1. https://www.zhihu.com/question/41949741/answer/318771336